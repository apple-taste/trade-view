# 资金管理系统（同花顺模式）

## 📊 设计理念

参考同花顺等A股交易软件的资金管理逻辑，实现：

**总资产 = 可用资金 + 持仓市值**

---

## 🔧 核心特性

### 1. 资金组成
- **总资产（Total Assets）**: 账户的全部资产价值
- **可用资金（Available Funds）**: 可用于开新仓的资金
- **持仓市值（Position Value）**: 所有持仓股票的当前市值

### 2. 资金变化逻辑

#### 开仓时：
```
可用资金 -= (买入价 × 手数 + 买入手续费)
持仓市值 += (买入价 × 手数)
总资产 = 可用资金 + 持仓市值
```

#### 平仓时：
```
可用资金 += (卖出价 × 手数 - 卖出手续费)
持仓市值 -= (原买入价 × 手数)
总资产 = 可用资金 + 持仓市值
```

#### 取消交易时：
```
该交易不影响资金曲线
is_deleted=True 的交易不参与计算
```

#### 股价变化时：
```
持仓市值 = Σ(持仓股票数量 × 当前价格)
总资产随持仓市值变化而变化
可用资金不变
```

### 3. 关键优势

✅ **实时反映市场变化**: 股票价格变化时，持仓市值和总资产实时更新
✅ **清晰的资金划分**: 可用资金和持仓市值分别统计，一目了然
✅ **符合A股交易习惯**: 与同花顺等软件逻辑一致，用户易于理解
✅ **支持回测分析**: 可以设置初始资金和日期，回测交易策略效果

---

## 💾 数据库结构

### CapitalHistory 表
```python
capital: Float          # 总资产（兼容旧数据）
available_funds: Float  # 可用资金
position_value: Float   # 持仓市值
date: Date             # 日期
user_id: Integer       # 用户ID
```

---

## 🔄 API 接口

### 1. GET /api/user/capital
获取当前资金信息

**响应示例**:
```json
{
  "capital": 105000.0,
  "total_assets": 105000.0,
  "available_funds": 50000.0,
  "position_value": 55000.0
}
```

### 2. GET /api/user/capital-history
获取资金历史记录

**响应示例**:
```json
[
  {
    "date": "2026-01-01",
    "capital": 100000.0,
    "available_funds": 100000.0,
    "position_value": 0.0
  },
  {
    "date": "2026-01-12",
    "capital": 105000.0,
    "available_funds": 50000.0,
    "position_value": 55000.0
  }
]
```

### 3. POST /api/user/capital
设置初始资金

**请求体**:
```json
{
  "capital": 100000.0,
  "date": "2026-01-01"
}
```

---

## 🎨 前端展示

### 1. 紧凑模式（Dashboard）
- 总资产（大字体显示）
- 可用资金（绿色）
- 持仓市值（蓝色）
- 用户信息

### 2. 完整模式（User页面）
- 总资产详情
- 可用资金和持仓市值对比
- 三线资金曲线图：
  - 总资产（金色）
  - 可用资金（绿色）
  - 持仓市值（蓝色）

---

## 📝 使用示例

### 场景1：开仓交易
```
初始状态：
- 可用资金: ¥100,000
- 持仓市值: ¥0
- 总资产: ¥100,000

买入操作：
- 股票代码: 600879
- 买入价: ¥15.50
- 手数: 1000
- 手续费: ¥46.5

开仓后：
- 可用资金: ¥84,453.5 (100000 - 15500 - 46.5)
- 持仓市值: ¥15,500 (15.5 × 1000)
- 总资产: ¥99,953.5
```

### 场景2：股价上涨
```
股价从¥15.50涨到¥16.00：

- 可用资金: ¥84,453.5 (不变)
- 持仓市值: ¥16,000 (16.0 × 1000) ⬆️
- 总资产: ¥100,453.5 ⬆️
```

### 场景3：平仓止盈
```
卖出操作：
- 卖出价: ¥16.00
- 卖出手续费: ¥48.0

平仓后：
- 可用资金: ¥100,405.5 (84453.5 + 16000 - 48)
- 持仓市值: ¥0
- 总资产: ¥100,405.5
```

---

## 🔄 迁移说明

已运行数据库迁移脚本 `migrate_add_capital_fields.py`：
- 添加 `available_funds` 字段
- 添加 `position_value` 字段
- 将现有的 `capital` 值复制到 `available_funds`（假设旧数据都是可用资金）

---

## ✨ 与旧版本对比

| 特性 | 旧版本 | 新版本（同花顺模式） |
|------|--------|---------------------|
| 总资产计算 | 固定计算 | 可用资金 + 持仓市值 |
| 股价变化 | 不影响总资产 | 实时影响总资产 ✅ |
| 资金划分 | 只有总资产 | 可用资金 + 持仓市值 ✅ |
| 取消交易 | 影响曲线 | 不影响曲线 ✅ |
| 曲线展示 | 单线 | 三线对比 ✅ |

---

## 🚀 未来改进

- [ ] 支持多币种资金管理
- [ ] 添加资金使用率（持仓市值/总资产）分析
- [ ] 支持自定义资金曲线时间范围
- [ ] 添加资金流水明细（每笔交易对资金的影响）

---

**开发日期**: 2026-01-12
**版本**: 1.0.0
**参考**: 同花顺资金管理逻辑
