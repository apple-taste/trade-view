#!/bin/bash

# AI深度分析日志监控脚本

LOG_FILE="backend.log"

echo "================================================================================
🤖 AI深度分析日志监控工具
================================================================================
"

# 检查日志文件是否存在
if [ ! -f "$LOG_FILE" ]; then
    echo "⚠️  日志文件不存在: $LOG_FILE"
    echo "💡 提示: 确保后端服务已启动并生成日志文件"
    exit 1
fi

# 显示菜单
echo "请选择监控模式："
echo ""
echo "1. 实时监控AI分析完整流程（输入+输出）"
echo "2. 实时监控AI分析输入数据"
echo "3. 实时监控AI分析输出结果"
echo "4. 实时监控ChatGPT API调用"
echo "5. 实时监控数据流向"
echo "6. 查看最近的AI分析记录"
echo "7. 查看AI分析统计"
echo "8. 退出"
echo ""

read -p "请选择 (1-8): " choice

case $choice in
    1)
        echo ""
        echo "🤖 实时监控AI分析完整流程..."
        echo "按 Ctrl+C 停止"
        echo "================================================================================
"
        tail -f "$LOG_FILE" | grep -E "(AI分析|ChatGPT|输入数据|输出数据|数据流向)"
        ;;
    2)
        echo ""
        echo "📥 实时监控AI分析输入数据..."
        echo "按 Ctrl+C 停止"
        echo "================================================================================
"
        tail -f "$LOG_FILE" | grep -E "(输入数据|交易记录|资金曲线|Prompt|User Message)"
        ;;
    3)
        echo ""
        echo "📤 实时监控AI分析输出结果..."
        echo "按 Ctrl+C 停止"
        echo "================================================================================
"
        tail -f "$LOG_FILE" | grep -E "(输出数据|AI完整响应|关键洞察|核心建议|分析结果)"
        ;;
    4)
        echo ""
        echo "🌐 实时监控ChatGPT API调用..."
        echo "按 Ctrl+C 停止"
        echo "================================================================================
"
        tail -f "$LOG_FILE" | grep -E "(ChatGPT|API|请求|响应|Token|HTTP状态码)"
        ;;
    5)
        echo ""
        echo "🔄 实时监控数据流向..."
        echo "按 Ctrl+C 停止"
        echo "================================================================================
"
        tail -f "$LOG_FILE" | grep -E "(数据流向|数据输入|数据输出|流向追踪|流向确认)"
        ;;
    6)
        echo ""
        echo "📋 最近的AI分析记录..."
        echo "================================================================================
"
        grep -E "(开始AI深度分析|AI分析完成)" "$LOG_FILE" | tail -20
        ;;
    7)
        echo ""
        echo "📊 AI分析统计..."
        echo "================================================================================
"
        echo "总AI分析次数: $(grep -c "开始AI深度分析" "$LOG_FILE" 2>/dev/null || echo "0")"
        echo "成功次数: $(grep -c "AI分析完成" "$LOG_FILE" 2>/dev/null || echo "0")"
        echo "失败次数: $(grep -c "AI分析失败" "$LOG_FILE" 2>/dev/null || echo "0")"
        echo ""
        echo "最近的AI分析:"
        grep -E "(开始AI深度分析|AI分析完成|AI分析失败)" "$LOG_FILE" | tail -10
        ;;
    8)
        echo "退出监控工具"
        exit 0
        ;;
    *)
        echo "无效选择"
        exit 1
        ;;
esac
