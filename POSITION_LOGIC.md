# 持仓计算逻辑说明（参考同花顺）

## 📊 核心概念区分

### 1. 历史资金曲线 vs 当前实时总资产

| 项目 | 历史资金曲线 | 当前实时总资产 |
|------|------------|--------------|
| **用途** | 回测分析、绩效统计 | 实时显示账户状态 |
| **持仓市值** | 使用买入价（持仓成本） | 使用最新市场价格 |
| **更新时机** | 交易发生时 | 实时查询 |
| **数据来源** | 数据库历史记录 | 实时计算 |

---

## 🔍 同花顺的逻辑

### 1. 历史资金曲线（回测模式）
```
目的：记录资金流动，用于回测分析

开仓时：
- 可用资金 -= (买入价 × 手数 + 手续费)
- 持仓市值 = 买入价 × 手数（持仓成本）
- 总资产 = 可用资金 + 持仓市值

平仓时：
- 可用资金 += (卖出价 × 手数 - 卖出手续费)
- 持仓市值 -= 买入价 × 手数（移除持仓成本）
- 总资产 = 可用资金 + 持仓市值

💡 为什么用买入价？
因为历史回测时，我们不知道每一天的实时股价，
只能用买入价作为持仓成本的保守估计。
```

### 2. 当前实时总资产（实时模式）
```
目的：显示账户的真实市场价值

计算方法：
1. 从最新资金记录获取可用资金
2. 查询所有status='open'的持仓
3. 对每个持仓：使用current_price（如果有）或buy_price
4. 持仓市值 = Σ(持仓数量 × 最新市场价格)
5. 总资产 = 可用资金 + 持仓市值

💡 为什么实时查询？
因为股票价格随时变化，持仓市值会实时波动，
总资产也会随之变化。这是同花顺等软件的标准做法。
```

---

## ✅ 修复后的实现

### 1. 历史资金曲线计算（`recalculate_capital_history`）

```python
# 持仓市值使用买入价（持仓成本）
position_value = 0.0
for pos_trade in positions.values():
    # 历史回测：使用买入价
    position_value += pos_trade.buy_price * pos_trade.shares

total_assets = available_funds + position_value
```

**特点**：
- ✅ 使用买入价作为持仓成本
- ✅ 不依赖current_price（可能为None）
- ✅ 适合历史回测和绩效分析

### 2. 当前实时总资产（`get_current_total_assets`）

```python
# 查询所有当前持仓（status='open'）
open_positions = db.query(Trade).filter(
    Trade.user_id == user_id,
    Trade.status == "open",
    Trade.is_deleted == False
).all()

# 计算实时持仓市值（使用最新市场价格）
position_value = 0.0
for pos in open_positions:
    # 使用最新价格（如果有），否则使用买入价
    price = pos.current_price if pos.current_price else pos.buy_price
    position_value += price * pos.shares

total_assets = available_funds + position_value
```

**特点**：
- ✅ 实时查询持仓状态
- ✅ 使用最新市场价格
- ✅ 准确反映账户真实价值

---

## 📈 典型场景示例

### 场景1：开仓后资金变化

```
初始状态：
- 可用资金: ¥100,000
- 持仓市值: ¥0
- 总资产: ¥100,000

买入操作：
- 股票: 600879
- 买入价: ¥15.50
- 手数: 1000
- 手续费: ¥46.5

开仓后（历史记录）：
- 可用资金: ¥84,453.5
- 持仓市值: ¥15,500（使用买入价）
- 总资产: ¥99,953.5

开仓后（实时显示）：
- 可用资金: ¥84,453.5
- 持仓市值: ¥15,500（当前价格 = 买入价）
- 总资产: ¥99,953.5
```

### 场景2：股价上涨后

```
股价从¥15.50涨到¥16.00

历史资金曲线（不变）：
- 可用资金: ¥84,453.5
- 持仓市值: ¥15,500（仍然是买入价）
- 总资产: ¥99,953.5（历史记录不变）

实时总资产（变化）：
- 可用资金: ¥84,453.5
- 持仓市值: ¥16,000（使用最新价格 ¥16.00） ⬆️
- 总资产: ¥100,453.5 ⬆️
```

### 场景3：平仓止盈

```
卖出操作：
- 卖出价: ¥16.00
- 卖出手续费: ¥48.0

平仓后（历史记录新增）：
- 可用资金: ¥100,405.5
- 持仓市值: ¥0
- 总资产: ¥100,405.5

平仓后（实时显示）：
- 可用资金: ¥100,405.5
- 持仓市值: ¥0
- 总资产: ¥100,405.5
```

---

## 🎯 关键要点

### 1. 两套计算系统
- **历史曲线系统**：记录资金流动，用买入价估计持仓市值
- **实时显示系统**：查询当前持仓，用最新价格计算持仓市值

### 2. 为什么不在历史中使用实时价格？
```
❌ 问题：
- 历史回测时，不知道过去每天的实时股价
- current_price字段可能为None
- 如果事后更新current_price，历史记录会变化，不利于回测分析

✅ 解决：
- 历史记录使用买入价（持仓成本）
- 实时显示单独计算，使用最新价格
```

### 3. 同花顺的实现方式
```
同花顺等软件：
1. 资金曲线：基于历史交易记录，持仓用成本价
2. 当前总资产：实时查询，持仓用最新市价
3. 持仓盈亏：(最新价 - 成本价) × 持仓数量
4. 今日盈亏：(最新价 - 昨收价) × 持仓数量
```

---

## 🔄 API 接口说明

### 1. GET /api/user/capital
```json
{
  "capital": 100453.5,           // 实时总资产
  "total_assets": 100453.5,      // 实时总资产
  "available_funds": 84453.5,    // 可用资金（从最新记录）
  "position_value": 16000.0      // 实时持仓市值（最新价格）
}
```

### 2. GET /api/user/capital-history
```json
[
  {
    "date": "2026-01-01",
    "capital": 100000.0,          // 初始总资产
    "available_funds": 100000.0,
    "position_value": 0.0
  },
  {
    "date": "2026-01-12",
    "capital": 99953.5,           // 开仓后总资产（买入价）
    "available_funds": 84453.5,
    "position_value": 15500.0     // 持仓成本（买入价）
  }
]
```

---

## 📝 总结

### 修复前的问题
❌ 历史资金曲线使用`current_price`（可能为None或不准确）
❌ 混淆了历史回测和实时显示两个概念

### 修复后的改进
✅ 历史资金曲线使用买入价（持仓成本）
✅ 实时总资产单独计算，使用最新市场价格
✅ 符合同花顺等A股软件的标准逻辑
✅ 历史回测数据稳定，不受价格变化影响

---

**修复日期**: 2026-01-12
**参考**: 同花顺、东方财富等A股交易软件逻辑
