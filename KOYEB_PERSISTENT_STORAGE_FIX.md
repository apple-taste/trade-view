# Koyeb 持久化存储问题修复方案

## 问题描述

重新部署后，之前注册的用户无法登录，提示"操作失败"或"用户名或密码错误"。

## 根本原因

**Koyeb不支持Dockerfile中的VOLUME声明**。每次重新部署时：
1. Koyeb创建新的容器实例
2. `/data`目录是容器内的临时目录
3. 容器销毁时，数据丢失
4. 新容器启动时，数据库文件不存在，需要重新创建

## 解决方案

### 方案1：使用Koyeb的持久化存储（推荐）

Koyeb支持持久化存储，但需要在其平台上配置，而不是在Dockerfile中。

**步骤**：
1. 在Koyeb控制台中配置持久化卷
2. 将数据库路径映射到持久化卷
3. 确保环境变量正确设置

**注意**：Koyeb的免费计划可能不支持持久化存储。

### 方案2：使用外部数据库（最佳实践）

使用PostgreSQL或其他外部数据库服务：

**优点**：
- 数据永久保存
- 支持多实例部署
- 更好的性能和可靠性

**缺点**：
- 需要额外的数据库服务
- 可能需要付费

**实现**：
1. 使用Koyeb的PostgreSQL插件
2. 或使用外部数据库服务（如Supabase、Railway等）
3. 修改`DATABASE_URL`环境变量

### 方案3：使用Koyeb的环境变量和持久化路径

如果Koyeb支持持久化存储，使用环境变量指定路径：

```json
{
  "env_vars": {
    "DB_DIR": "/persistent/data",
    "JWT_SECRET": "..."
  }
}
```

### 方案4：每次部署时重新注册（临时方案）

如果以上方案都不可行，用户需要在每次重新部署后重新注册账号。

## 当前状态

- ✅ 已添加详细的数据库日志
- ✅ 已添加用户数量调试日志
- ✅ 已配置`DB_DIR`环境变量
- ⚠️  Koyeb可能不支持VOLUME挂载

## 下一步行动

1. **检查日志**：确认数据库文件是否存在
2. **测试注册**：尝试注册新用户，检查是否能成功
3. **检查Koyeb文档**：确认Koyeb是否支持持久化存储
4. **如果数据仍然丢失**：考虑使用外部数据库（PostgreSQL）

## 临时解决方案

如果数据持续丢失，建议：
1. 每次部署后重新注册账号
2. 或者使用外部数据库服务
3. 或者联系Koyeb支持，询问持久化存储配置

## 验证方法

1. 部署完成后，检查日志中的数据库路径
2. 注册一个新用户
3. 等待5分钟后重新部署
4. 尝试登录，如果失败，说明数据丢失
5. 检查日志中的用户数量
